{
  "instructions_for_new_agent": "You are in a NEW project. This JSON describes USEFUL code in ANOTHER project (the 'source' project). Your job: COPY that useful code FROM the source project INTO your current project. No cross-pollination: do not import from the source project; copy the file contents into your project's folders at the same relative paths (e.g. source src/lib/api.js → your project src/lib/api.js). Where a file is partial (e.g. stores.js), EXTRACT only the described parts and merge them into your existing files. Do NOT copy ChatInput.svelte or any voice/microphone/Send-button logic; that code is broken. Build your own chat input in your project and plug it into the same send/stream flow.",
  "source_project_root": "c:\\CURSOR\\lm-studio-ui",
  "path_separator_note": "All source_path values are relative to source_project_root. Use path.join(source_project_root, source_path) or equivalent to read files. Copy into your project at the same relative path from your project root unless extract_merge is true.",
  "do_not_copy": [
    "src/lib/components/ChatInput.svelte",
    "Any microphone, voice, speech recognition, or Send-button logic",
    "public/mic-reliability-test.js",
    "scripts/run-mic-test.mjs"
  ],
  "chat_input_correct_behavior": {
    "purpose": "Specification for how the chat input MUST behave when implemented correctly. Implement this in your own component; do not copy the broken implementation from the source project.",
    "text_via_keyboard": {
      "input": "One textarea (or contenteditable) bound to a single reactive value (e.g. text). User types; that value updates on every keystroke (or on input event). No other code overwrites this value except: (1) clearing on send, (2) optional insert-from-outside (e.g. suggestion chips).",
      "send_button": "Enabled whenever the trimmed input has at least one character. Disabled when empty. No other condition (e.g. streaming state) should disable the button for the next message once the current response has finished.",
      "send_action": "On Send click or Ctrl+Enter: read the current input value, trim it; if non-empty and not currently streaming, call the parent's send handler (e.g. onSend(text, imageUrls)); then clear the input value so the user can type the next message immediately.",
      "after_first_message": "After the first message is sent and the model responds, the input must behave identically: user can type a second message, the Send button must be enabled when there is text, and Send must submit that text. The input must not stay disabled, and the Send button must not stay disabled, after the stream ends. Ensure isStreaming (or equivalent) is set to false when the stream completes so the UI is not stuck in 'streaming' state.",
      "single_source_of_truth": "The visible text in the input must be the same as the value your Send logic reads. Use one state variable for the input content; bind the textarea to it. Do not rely on a separate DOM poll or a second variable that can get out of sync."
    },
    "voice_to_text": {
      "if_implemented": "Optional. If you add voice input, it should work like this.",
      "one_shot_recommended": "Prefer one-shot: user clicks a Speak/Voice button, the app captures one utterance (e.g. browser SpeechRecognition with continuous: false, or a single final result), appends that transcript to the current input text once, then stops. User can then send (keyboard or button) or click Speak again to add more. This avoids 'listening' state, lockups, and second-message failures.",
      "no_persistent_listening": "Do not leave recognition running in a persistent 'listening' state across sends. Either: (1) one-shot per click, or (2) if you keep listening, fully stop and release the mic on Send, and start a fresh recognition only when the user explicitly clicks Speak again. The browser must release the microphone so the next use is a clean start.",
      "transcript_into_input": "Voice result must update the same single state variable that the textarea uses. Append the final transcript (one string) to that value once when recognition ends; do not append multiple times (e.g. do not append every interim or every result event, or you get repeated text). Use only the final result or the last final segment.",
      "send_after_voice": "After voice fills the input, the Send button must be enabled (same rule as keyboard: enabled when trimmed content is non-empty). User must be able to send that message and then send a second message (typed or spoken) without the UI getting stuck."
    },
    "summary": "Input: one binding, one state. Send: enabled when text present; on send, submit then clear. After first response, second message must work the same. Voice: one-shot or full release between uses; transcript in the same input state; no repeated/cumulative transcript."
  },
  "sections": [
    {
      "id": "api",
      "name": "LM Studio API",
      "what_it_is": "HTTP client for LM Studio: list models, load model, stream chat completions (OpenAI-compat). Base URL from localStorage lmStudioBaseUrl or proxy in dev. Used by chat and model selector.",
      "source_path": "src/lib/api.js",
      "copy_entire_file": true,
      "dependencies_from_this_list": []
    },
    {
      "id": "database",
      "name": "Conversation database",
      "what_it_is": "Dexie (IndexedDB) for conversations and messages: createConversation, listConversations, getMessages, addMessage, updateConversation, deleteConversation, clearMessages, deleteMessage, getMessageCount, deleteAllConversations.",
      "source_path": "src/lib/db.js",
      "copy_entire_file": true,
      "dependencies_from_this_list": [],
      "npm_dependency": "dexie"
    },
    {
      "id": "audio",
      "name": "Audio feedback",
      "what_it_is": "Sound effects: playClick, playSend, playComplete. Optional; can be no-op if you skip audio.",
      "source_path": "src/lib/audio.js",
      "copy_entire_file": true,
      "dependencies_from_this_list": []
    },
    {
      "id": "utils",
      "name": "Utilities",
      "what_it_is": "generateId and other shared helpers used by ChatView, MessageBubble, etc.",
      "source_path": "src/lib/utils.js",
      "copy_entire_file": true,
      "dependencies_from_this_list": []
    },
    {
      "id": "web_search",
      "name": "Web search (DuckDuckGo)",
      "what_it_is": "searchDuckDuckGo, formatSearchResultForChat. Used when user enables 'search web' and sends; injects search results into context.",
      "source_path": "src/lib/duckduckgo.js",
      "copy_entire_file": true,
      "dependencies_from_this_list": []
    },
    {
      "id": "conversation_ui",
      "name": "Sidebar and conversation rail",
      "what_it_is": "Sidebar: list of conversations, new chat, switch chat. ConvoRail: compact rail for cockpit. Both read from stores (conversations, activeConversationId) and db.",
      "source_files": [
        { "source_path": "src/lib/components/Sidebar.svelte", "copy_entire_file": true },
        { "source_path": "src/lib/components/ConvoRail.svelte", "copy_entire_file": true }
      ],
      "dependencies_from_this_list": ["database", "stores_conversations", "utils"]
    },
    {
      "id": "message_display",
      "name": "Message list and bubbles",
      "what_it_is": "MessageList: renders activeMessages, scroll, copy/pin. MessageBubble: one message (user/assistant), markdown, stats, copy, pin.",
      "source_files": [
        { "source_path": "src/lib/components/MessageList.svelte", "copy_entire_file": true },
        { "source_path": "src/lib/components/MessageBubble.svelte", "copy_entire_file": true }
      ],
      "dependencies_from_this_list": ["markdown", "utils"]
    },
    {
      "id": "markdown",
      "name": "Markdown rendering",
      "what_it_is": "Renders assistant markdown in message bubbles.",
      "source_path": "src/lib/markdown.js",
      "copy_entire_file": true,
      "dependencies_from_this_list": []
    },
    {
      "id": "chat_view_send_stream",
      "name": "Chat view (send + stream only; no input)",
      "what_it_is": "ChatView.svelte contains: sendUserMessage (builds API messages, calls streamChatCompletion), stream handling (onChunk, onDone, isStreaming), abort, error handling, addMessage to db, loadMessages, clearChat, regenerate, exportChat, runWebSearch. It also mounts ChatInput—when you copy ChatView, REPLACE the ChatInput import and usage with your own input component that calls the same onSend callback.",
      "source_path": "src/lib/components/ChatView.svelte",
      "copy_entire_file": false,
      "extract_merge": "Copy the file into your project, then replace the ChatInput component with your own input; pass your input's submit handler as onSend so it calls sendUserMessage with (text, imageUrls). Keep the rest of ChatView (stream logic, MessageList, db, api, stores) as-is.",
      "dependencies_from_this_list": ["api", "database", "message_display", "web_search", "audio", "utils", "stores_chat"]
    },
    {
      "id": "settings",
      "name": "Settings panel and store",
      "what_it_is": "SettingsPanel.svelte: UI for temperature, max_tokens, system_prompt, preset, model URL, audio toggles, etc. stores.js holds settings writable and updateSettings; per-layout and effectiveModelId.",
      "source_files": [
        { "source_path": "src/lib/components/SettingsPanel.svelte", "copy_entire_file": true },
        { "source_path": "src/lib/stores.js", "copy_entire_file": false, "extract_merge": "Extract: settings (derived), updateSettings, DEFAULT_SETTINGS, settingsByLayout, presetDefaultModels, and any localStorage persist for these. Merge into your store module." }
      ],
      "dependencies_from_this_list": ["api", "model_defaults", "model_icons"]
    },
    {
      "id": "model_selector",
      "name": "Model selector and presets",
      "what_it_is": "ModelSelector.svelte: dropdown to pick model, load model. ModelSelectorSlot.svelte: same for arena columns A/B/C/D. PresetSelect.svelte: system prompt presets (General, Code, etc.).",
      "source_files": [
        { "source_path": "src/lib/components/ModelSelector.svelte", "copy_entire_file": true },
        { "source_path": "src/lib/components/ModelSelectorSlot.svelte", "copy_entire_file": true },
        { "source_path": "src/lib/components/PresetSelect.svelte", "copy_entire_file": true }
      ],
      "dependencies_from_this_list": ["api", "model_defaults", "model_icons", "huggingface", "stores_models"]
    },
    {
      "id": "model_defaults",
      "name": "Model defaults",
      "what_it_is": "getDefaultsForModel(modelId) for params; used by selector and settings.",
      "source_path": "src/lib/modelDefaults.js",
      "copy_entire_file": true,
      "dependencies_from_this_list": []
    },
    {
      "id": "model_icons",
      "name": "Model icons",
      "what_it_is": "getModelIcon, getQuantization, ensureModelIcons, modelIconOverrides; used by model selector.",
      "source_path": "src/lib/modelIcons.js",
      "copy_entire_file": true,
      "dependencies_from_this_list": []
    },
    {
      "id": "huggingface",
      "name": "Hugging Face helpers",
      "what_it_is": "getRecommendedFromHf and related; optional for model selector.",
      "source_path": "src/lib/huggingface.js",
      "copy_entire_file": true,
      "dependencies_from_this_list": []
    },
    {
      "id": "themes",
      "name": "UI color themes",
      "what_it_is": "Root data-ui-theme drives CSS variables. themeOptions.js = list of theme ids/labels. UiThemeSelect, ThemePickerModal, ThemeToggle = UI. Theme CSS is in app.css under [data-ui-theme=\"...\"].",
      "source_files": [
        { "source_path": "src/lib/themeOptions.js", "copy_entire_file": true },
        { "source_path": "src/lib/components/UiThemeSelect.svelte", "copy_entire_file": true },
        { "source_path": "src/lib/components/ThemePickerModal.svelte", "copy_entire_file": true },
        { "source_path": "src/lib/components/ThemeToggle.svelte", "copy_entire_file": true },
        { "source_path": "src/app.css", "copy_entire_file": false, "extract_merge": "Copy only the theme blocks: from /* UI theme variables */ (around line 245) through the end of the last [data-ui-theme=\"...\"] and .dark[data-ui-theme=\"...\"] blocks. Merge into your app.css." }
      ],
      "stores_extract": "From stores.js: uiTheme writable, theme writable (dark/light/system), and their localStorage + document.documentElement.dataset.uiTheme subscribe logic.",
      "dependencies_from_this_list": []
    },
    {
      "id": "layouts",
      "name": "Layouts (cockpit vs arena)",
      "what_it_is": "Two modes: cockpit (single chat + Intel panel) and arena (1–4 model columns, DashboardArena). Layout switcher in header; effectiveModelId = arena ? dashboardModelA : selectedModelId.",
      "source_files": [
        { "source_path": "src/lib/components/DashboardArena.svelte", "copy_entire_file": false, "extract_merge": "Copy file; replace ChatInput import and usage with your own input component. All other arena logic (multi-slot run, messages per column) is fine." },
        { "source_path": "src/App.svelte", "copy_entire_file": false, "extract_merge": "Copy only: LAYOUT_OPTS, header layout switcher buttons, {#if layout === 'cockpit'} branch (header + ConvoRail + main + IntelPanel), {:else if layout === 'arena'} branch (header + panel count + ModelSelectorSlot A/B/C/D + DashboardArena). Omit anything that references ChatInput or broken input. Wire layout to your own main content." }
      ],
      "stores_extract": "From stores.js: layout writable, OLD_TO_NEW_LAYOUT, getInitialLayout(), dashboardModelA/B/C/D, effectiveModelId derived, cockpitIntelOpen, arenaPanelCount, and their localStorage persist.",
      "dependencies_from_this_list": ["model_selector", "themes"]
    },
    {
      "id": "stores_conversations",
      "name": "Stores: conversations and chat",
      "what_it_is": "activeConversationId, conversations, activeMessages, chatError, insertIntoInput, insertAppend, suggestionExpanded, chatCommand, isStreaming, liveTokens, liveTokPerSec, lastResponseTokPerSec, lastResponseTokens, pushTokSample, tokSeries, etc.",
      "source_path": "src/lib/stores.js",
      "copy_entire_file": false,
      "extract_merge": "Extract conversation/chat-related writables and derived and their subscribe/persist logic. Do not copy ChatInput-related or broken input logic. Merge into your store module.",
      "dependencies_from_this_list": []
    },
    {
      "id": "stores_chat",
      "name": "Stores used by ChatView",
      "what_it_is": "Same stores.js: activeConversationId, activeMessages, conversations, settings, effectiveModelId, isStreaming, webSearchInProgress, chatError, insertIntoInput, insertAppend, suggestionExpanded, chatCommand, liveTokens, pushTokSample, liveTokPerSec, lastResponseTokPerSec, lastResponseTokens.",
      "source_path": "src/lib/stores.js",
      "copy_entire_file": false,
      "extract_merge": "See stores_conversations; ensure these keys exist for ChatView.",
      "dependencies_from_this_list": []
    },
    {
      "id": "stores_models",
      "name": "Stores: models and selection",
      "what_it_is": "models, selectedModelId, effectiveModelId (if not under layouts), hardware.",
      "source_path": "src/lib/stores.js",
      "copy_entire_file": false,
      "extract_merge": "Extract models, selectedModelId, hardware writables and any subscribe. Merge into your store module.",
      "dependencies_from_this_list": []
    },
    {
      "id": "file_handling",
      "name": "File/image handling",
      "what_it_is": "routeFiles, routeFile: route images/PDFs/text for chat; used when user pastes or drops files. Optional if you do not need image/PDF input.",
      "source_path": "src/lib/fileHandler.js",
      "copy_entire_file": true,
      "dependencies_from_this_list": ["api"]
    },
    {
      "id": "hardware",
      "name": "Hardware detection",
      "what_it_is": "detectHardware (CPU cores); used by stores and possibly settings.",
      "source_path": "src/lib/hardware.js",
      "copy_entire_file": true,
      "dependencies_from_this_list": []
    },
    {
      "id": "command_palette",
      "name": "Command palette",
      "what_it_is": "Global shortcut (e.g. Ctrl+K) to open palette: new chat, clear, export, settings, etc.",
      "source_path": "src/lib/components/CommandPalette.svelte",
      "copy_entire_file": true,
      "dependencies_from_this_list": ["database", "utils", "themes"]
    },
    {
      "id": "intel_panel",
      "name": "Intel panel (cockpit)",
      "what_it_is": "Optional right panel in cockpit: IntelPanel.svelte. Can skip if you do not need it.",
      "source_path": "src/lib/components/IntelPanel.svelte",
      "copy_entire_file": true,
      "dependencies_from_this_list": []
    },
    {
      "id": "audio_manager",
      "name": "Audio manager",
      "what_it_is": "AudioManager.svelte: wires settings (audio_enabled, volume) to AudioContext; used for playClick/playSend/playComplete.",
      "source_path": "src/lib/components/AudioManager.svelte",
      "copy_entire_file": true,
      "dependencies_from_this_list": ["audio", "settings"]
    }
  ],
  "all_source_paths_to_copy_or_extract": [
    "src/app.css",
    "src/lib/api.js",
    "src/lib/audio.js",
    "src/lib/db.js",
    "src/lib/duckduckgo.js",
    "src/lib/fileHandler.js",
    "src/lib/hardware.js",
    "src/lib/huggingface.js",
    "src/lib/markdown.js",
    "src/lib/modelDefaults.js",
    "src/lib/modelIcons.js",
    "src/lib/stores.js",
    "src/lib/themeOptions.js",
    "src/lib/utils.js",
    "src/App.svelte",
    "src/lib/components/AudioManager.svelte",
    "src/lib/components/ChatView.svelte",
    "src/lib/components/CommandPalette.svelte",
    "src/lib/components/ConvoRail.svelte",
    "src/lib/components/DashboardArena.svelte",
    "src/lib/components/IntelPanel.svelte",
    "src/lib/components/MessageBubble.svelte",
    "src/lib/components/MessageList.svelte",
    "src/lib/components/ModelSelector.svelte",
    "src/lib/components/ModelSelectorSlot.svelte",
    "src/lib/components/PresetSelect.svelte",
    "src/lib/components/SettingsPanel.svelte",
    "src/lib/components/Sidebar.svelte",
    "src/lib/components/ThemePickerModal.svelte",
    "src/lib/components/ThemeToggle.svelte",
    "src/lib/components/UiThemeSelect.svelte"
  ],
  "index_by_source_path": {
    "src/app.css": "themes (extract theme CSS only)",
    "src/lib/api.js": "api",
    "src/lib/audio.js": "audio",
    "src/lib/db.js": "database",
    "src/lib/duckduckgo.js": "web_search",
    "src/lib/fileHandler.js": "file_handling",
    "src/lib/hardware.js": "hardware",
    "src/lib/huggingface.js": "huggingface",
    "src/lib/markdown.js": "markdown",
    "src/lib/modelDefaults.js": "model_defaults",
    "src/lib/modelIcons.js": "model_icons",
    "src/lib/stores.js": "themes + layouts + stores_conversations + stores_chat + stores_models + settings (extract and merge)",
    "src/lib/themeOptions.js": "themes",
    "src/lib/utils.js": "utils",
    "src/App.svelte": "layouts (extract layout branches only)",
    "src/lib/components/AudioManager.svelte": "audio_manager",
    "src/lib/components/ChatView.svelte": "chat_view_send_stream",
    "src/lib/components/CommandPalette.svelte": "command_palette",
    "src/lib/components/ConvoRail.svelte": "conversation_ui",
    "src/lib/components/DashboardArena.svelte": "layouts",
    "src/lib/components/IntelPanel.svelte": "intel_panel",
    "src/lib/components/MessageBubble.svelte": "message_display",
    "src/lib/components/MessageList.svelte": "message_display",
    "src/lib/components/ModelSelector.svelte": "model_selector",
    "src/lib/components/ModelSelectorSlot.svelte": "model_selector",
    "src/lib/components/PresetSelect.svelte": "model_selector",
    "src/lib/components/SettingsPanel.svelte": "settings",
    "src/lib/components/Sidebar.svelte": "conversation_ui",
    "src/lib/components/ThemePickerModal.svelte": "themes",
    "src/lib/components/ThemeToggle.svelte": "themes",
    "src/lib/components/UiThemeSelect.svelte": "themes"
  }
}
